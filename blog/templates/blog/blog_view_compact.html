{% extends "blog/base.html" %}
{% load static %}

{% block content %}
<div class="container"
     data-toggle-like-url-base="{% url 'toggle_like_photo' photo_id=0 %}"
     data-is-authenticated="{{ user.is_authenticated|yesno:'true,false' }}">
    
    <!-- Breadcrumb navigation -->
    <nav aria-label="breadcrumb" class="breadcrumb-container">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
            <li class="breadcrumb-item active" aria-current="page">Blog di {{ blog_owner.username }}</li>
        </ol>
    </nav>
    
    <div class="blog-header mb-4">
        <div>
            <h2>Blog di {{ blog_owner.username }}</h2>
            <p style="font-style: italic;">{{ settings.tagline }}</p>
        </div>
    </div>
    
    <!-- Album container -->
    <div class="albums-container">
        {% regroup photos_data by album_title as album_list %}
        
        {% for album in album_list %}
            <div class="album-section mb-4">
                <div class="section-header">
                    <h2 class="album-title">{{ album.grouper }}</h2>
                    {% if user.is_authenticated and user.id == blog_owner.id %}
                    <a href="{% url 'album_detail' pk=album.list.0.album_id %}" class="add-button" title="Aggiungi foto">
                        <i class="fas fa-plus"></i>
                    </a>
                    {% endif %}
                </div>
                <div class="photo-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; background-color: var(--photo-grid-bg, #ffffff); padding: 20px; border-radius: 8px;">
                    {% for photo in album.list %}
                        <div class="photo-thumbnail" data-photo-id="{{ photo.id }}" style="width: 200px; height: 200px; overflow: hidden; border-radius: 8px; cursor: pointer; position: relative;">
                            <img src="{{ photo.thumbnail_url|default:photo.image_url }}" alt="{{ photo.caption|default:'Foto' }}" style="width: 100%; height: 100%; object-fit: cover;">
                            <div class="photo-caption-overlay">{{ photo.caption|default:'Foto' }}</div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% empty %}
            <p>Questo blog non ha ancora pubblicato foto.</p>
        {% endfor %}
    </div>
</div>

<!-- Photo Modal -->
<div class="photo-modal-overlay" id="photoModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9);  backdrop-filter: blur(40px); /* Sfocatura dello sfondo */
-webkit-backdrop-filter: blur(10px); /* Per compatibilità Safari */
z-index: 99999;">
    <!-- Controlli di navigazione esterni alla foto -->
    <button class="nav-prev" style="position: fixed; left: 30px; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 100000; box-shadow: 0 0 15px rgba(0,0,0,0.3);"><i class="fas fa-chevron-left"></i></button>
    
    <button class="close-modal" style="position: fixed; top: 30px; right: 30px; width: 50px; height: 50px; border-radius: 50%; background-color: rgba(255,255,255,0.2); color: white; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 0 15px rgba(0,0,0,0.3); z-index: 100000; font-size: 24px;">&times;</button>
    
    <button class="nav-next" style="position: fixed; right: 30px; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 100000; box-shadow: 0 0 15px rgba(0,0,0,0.3);"><i class="fas fa-chevron-right"></i></button>
    
    <div class="photo-modal-content" style="position: relative; width: 98%; max-width: 1800px; margin: 10px auto; display: flex; flex-direction: column;">
        
        <!-- Full-width photo frame -->
        <div class="photo-frame" style="background-color: white; border-radius: 8px; overflow: hidden; width: 100%; box-shadow: 0 5px 15px rgba(0,0,0,0.3); padding: 15px; flex-shrink: 0;">
            <div class="modal-navigation" style="display: flex; align-items: center; justify-content: center; width: 100%; background-color: white; position: relative;">
                <div class="modal-image-container" style="width: 100%; display: flex; justify-content: center; align-items: center; background-color: #ffffff; height: calc(100vh - 150px); border-radius: 4px;">
                    <img id="modalImage" src="" alt="Foto" style="max-width: 100%; max-height: 100%; object-fit: contain;">
                </div>
            </div>
            
            <div class="modal-info" style="color: #333; padding: 15px; text-align: center; background-color: white;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h3 id="modalCaption" style="margin-bottom: 0; color: #333;"></h3>
                    <a id="downloadButton" href="#" download style="background-color: #000000; color: white; border: none; border-radius: 4px; padding: 8px 16px; font-size: 0.9rem; display: flex; align-items: center; gap: 8px; text-decoration: none; transition: background-color 0.3s;">
                        <i class="fas fa-download"></i> Scarica originale
                    </a>
                </div>
                <p id="modalDescription" style="margin-bottom: 10px; font-style: italic; color: #666; font-size: 0.9em;"></p>
                <div class="modal-metadata" style="display: flex; justify-content: center; gap: 15px; font-size: 0.8em; color: #888; border-top: 1px solid #eee; padding-top: 10px;">
                    <span id="modalCamera"></span>
                    <span id="modalSettings"></span>
                    <span id="modalDate"></span>
                    <span><i class="fas fa-eye"></i> <span id="viewCount">0</span> visualizzazioni</span>
                    <span style="cursor: pointer;"><i class="fas fa-heart" id="likeIcon"></i> <span id="likeCount">0</span> likes</span>
                </div>
            </div>
        </div>
        

    </div>
</div>

<!-- Embed photos data safely -->
{{ photos_data|json_script:"photos-data-json" }}
{% endblock %}

<!-- Aggiungiamo un elemento per indicare se l'utente è autenticato -->
<div id="auth-status" data-is-authenticated="{{ user.is_authenticated|yesno:'true,false' }}" style="display: none;"></div>

{% block extra_css %}
<!-- Aggiungiamo il meta tag per il CSRF token -->
<meta name="csrf-token" content="{{ csrf_token }}">
<style>
/* Blog header */
.blog-header {
    text-align: center;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border-color);
    margin-bottom: 30px;
}

/* Album sections */
.albums-container {
    max-width: 1200px;
    margin: 0 auto;
}

.album-title {
    margin-bottom: 15px;
    padding-bottom: 5px;
    border-bottom: 1px solid var(--border-color);
    color: var(--heading-color);
}

/* Photo grid */
.photo-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, 80px);
    gap: 5px;
    background-color: #fff;
    padding: 10px;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

/* Photo thumbnails */
.photo-thumbnail {
    width: 80px !important;
    height: 80px !important;
    overflow: hidden;
    border-radius: 4px;
    cursor: pointer;
    transition: transform 0.2s ease;
    position: relative;
}

/* Pulsante VR per le foto */
.vr-view-button {
    position: absolute;
    bottom: 8px;
    right: 8px;
    width: 30px;
    height: 30px;
    border-radius: 0;
    background-color: transparent;
    color: white;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 1000;
    transition: all 0.2s ease;
    opacity: 0.6;
    font-size: 16px;
    text-shadow: 0 0 3px rgba(0, 0, 0, 0.7);
}

.vr-view-button:hover {
    opacity: 1;
    transform: scale(1.1);
    background-color: transparent;
}

.photo-thumbnail:hover {
    transform: scale(1.05);
    box-shadow: 0 3px 10px rgba(0,0,0,0.2);
    z-index: 1;
}

.photo-thumbnail img {
    width: 80px !important;
    height: 80px !important;
    object-fit: cover;
}
</style>
{% endblock %}

{% block extra_js %}
{% load static %}
<script src="{% static 'js/vr-viewer.js' %}"></script>
<script src="{% static 'js/photo-interactions.js' %}"></script>
<script src="{% static 'js/blog-view-compact.js' %}"></script>
<script>
$(document).ready(function() {
    console.log("Document ready, initializing photo viewer...");
    
    // Parse photos data
    let photosData = [];
    try {
        const photosDataJson = document.getElementById('photos-data-json').textContent;
        photosData = JSON.parse(photosDataJson || '[]');
        console.log("Loaded photo data:", photosData.length, "photos");
    } catch (e) {
        console.error("Error parsing photos data:", e);
    }
    
    let currentPhotoIndex = -1;
    let currentPhotoId = -1;
    
    // Direct DOM references
    const $modal = $("#photoModal");
    const $modalImage = $("#modalImage");
    const $modalCaption = $("#modalCaption");
    const $modalDescription = $("#modalDescription");
    const $modalCamera = $("#modalCamera");
    const $modalSettings = $("#modalSettings");
    const $modalDate = $("#modalDate");
    const $navPrev = $(".nav-prev");
    const $navNext = $(".nav-next");
    const $closeModal = $(".close-modal");
    const $commentsContainer = $("#comments-container");
    const $commentText = $("#comment-text");
    const $submitComment = $("#submit-comment");
    
    // Adjust modal height on window resize
    $(window).resize(function() {
        $(".modal-comments").css("height", "calc(100vh - 40px)");
    });
    
    // Debug click events
    $(".photo-thumbnail").on("click", function() {
        console.log("Thumbnail clicked!");
        const photoId = parseInt($(this).data("photo-id"));
        console.log("Photo ID:", photoId);
        openPhotoModal(photoId);
        return false; // Prevent event bubbling
    });
    
    // Close modal handlers
    $closeModal.on("click", function() {
        console.log("Close button clicked");
        closeModal();
        return false;
    });
    
    $modal.on("click", function(e) {
        if (e.target === this) {
            console.log("Modal background clicked");
            closeModal();
        }
    });
    
    // Navigation handlers
    $navPrev.on("click", function() {
        console.log("Previous button clicked");
        if (currentPhotoIndex > 0) {
            openPhotoModal(photosData[currentPhotoIndex - 1].id);
        }
        return false;
    });
    
    $navNext.on("click", function() {
        console.log("Next button clicked");
        if (currentPhotoIndex < photosData.length - 1) {
            openPhotoModal(photosData[currentPhotoIndex + 1].id);
        }
        return false;
    });
    
    // Keyboard navigation
    $(document).keydown(function(e) {
        if ($modal.is(":visible")) {
            if (e.key === "ArrowLeft") {
                $navPrev.click();
            } else if (e.key === "ArrowRight") {
                $navNext.click();
            } else if (e.key === "Escape") {
                closeModal();
            }
        }
    });
    
    // Function to load photo statistics
    function loadPhotoStats(photoId) {
        // Increment view count
        $.ajax({
            url: `/api/photo/${photoId}/view/`,
            type: 'POST',
            headers: {
                'X-CSRFToken': $('meta[name="csrf-token"]').attr('content')
            },
            success: function(data) {
                $('#viewCount').text(data.views);
                $('#likeCount').text(data.likes);
                
                // Update like icon
                if (data.user_liked) {
                    $('#likeIcon').addClass('text-danger');
                } else {
                    $('#likeIcon').removeClass('text-danger');
                }
            }
        });
    }
    
    // Function to toggle like on a photo
    function toggleLike(photoId) {
        console.log('Toggling like for photo ID:', photoId);
        
        // Client-side like for all users using localStorage
        const likedPhotosKey = 'likedPhotos';
        let likedPhotos = JSON.parse(localStorage.getItem(likedPhotosKey) || '{}');
        
        // Toggle like status
        const isLiked = likedPhotos[photoId];
        if (isLiked) {
            delete likedPhotos[photoId];
            $('#likeIcon').removeClass('text-danger');
            // Decrease like count if > 0
            let currentLikes = parseInt($('#likeCount').text());
            if (currentLikes > 0) currentLikes--;
            $('#likeCount').text(currentLikes);
        } else {
            likedPhotos[photoId] = true;
            $('#likeIcon').addClass('text-danger');
            // Increase like count
            let currentLikes = parseInt($('#likeCount').text());
            currentLikes++;
            $('#likeCount').text(currentLikes);
        }
        
        // Save updated likes to localStorage
        localStorage.setItem(likedPhotosKey, JSON.stringify(likedPhotos));
    }
    
    // Add click handler for like button
    $(document).on('click', '#likeIcon', function() {
        toggleLike(currentPhotoId);
    });
    
    // Initialize color picker
    $('.color-option').click(function() {
        const selectedColor = $(this).data('color');
        document.documentElement.style.setProperty('--photo-grid-bg', selectedColor);
        
        // Save preference to localStorage
        localStorage.setItem('photoGridBgColor', selectedColor);
        
        // Update active state
        $('.color-option').removeClass('active');
        $(this).addClass('active');
    });
    
    // Function to open modal with specific photo
    function openPhotoModal(photoId) {
        console.log("Opening modal for photo ID:", photoId);
        currentPhotoId = photoId;
        
        const photo = photosData.find(p => p.id === photoId);
        if (!photo) {
            console.error("Photo not found:", photoId);
            return;
        }
        
        // Find index for navigation
        currentPhotoIndex = photosData.findIndex(p => p.id === photoId);
        
        // Mostra subito il modal per dare feedback visivo immediato
        $modal.css({
            "display": "block",
            "opacity": 0
        }).animate({
            "opacity": 1
        }, 300);
        
        // Prevent body scrolling
        $("body").css("overflow", "hidden");
        
        // Precarica l'immagine
        const img = new Image();
        img.onload = function() {
            // Update modal content solo dopo che l'immagine è caricata
            $modalImage.attr("src", photo.image_url);
            $modalCaption.text(photo.caption || "Senza titolo");
            $modalDescription.text(photo.description || "");
            
            // Aggiorna il pulsante di download
            $("#downloadButton").attr("href", photo.image_url);
            $("#downloadButton").attr("download", (photo.caption || "photo") + ".jpg");
            
            // Update metadata
            $modalCamera.text(photo.camera_model ? `Camera: ${photo.camera_model}` : "");
            
            const settings = [];
            if (photo.focal_length) settings.push(photo.focal_length);
            if (photo.f_number) settings.push(`f/${photo.f_number}`);
            if (photo.exposure) settings.push(`${photo.exposure}s`);
            if (photo.iso) settings.push(`ISO ${photo.iso}`);
            $modalSettings.text(settings.length ? settings.join(" | ") : "");
            
            $modalDate.text(photo.date_taken ? `Scattata: ${photo.date_taken}` : "");
            
            // Show/hide navigation buttons
            $navPrev.toggle(currentPhotoIndex > 0);
            $navNext.toggle(currentPhotoIndex < photosData.length - 1);
        };
        img.src = photo.image_url;
        
        // Carica statistiche
        loadPhotoStats(photoId);
        
        // Check if user has liked this photo (using localStorage for all users)
        const likedPhotosKey = 'likedPhotos';
        let likedPhotos = JSON.parse(localStorage.getItem(likedPhotosKey) || '{}');
        
        if (likedPhotos[photoId]) {
            $('#likeIcon').addClass('text-danger');
        } else {
            $('#likeIcon').removeClass('text-danger');
        }
    }
    
    // Function to close modal
    function closeModal() {
        console.log("Closing modal");
        $modal.css("display", "none");
        $("body").css("overflow", "auto");
    }
    
    console.log("Photo viewer initialization complete");
    
    // Controlla se c'è un ID di foto da aprire automaticamente
    const openPhotoId = sessionStorage.getItem('openPhotoId');
    if (openPhotoId) {
        // Converti l'ID da stringa a numero
        const photoId = parseInt(openPhotoId);
        console.log("Auto-opening photo ID:", photoId);
        
        // Apri il modal con la foto specificata immediatamente
        openPhotoModal(photoId);
        // Rimuovi l'ID dalla sessionStorage per evitare che si riapra alla prossima visita
        sessionStorage.removeItem('openPhotoId');
    }
});

    // Initialize color selector
    $(document).ready(function() {
        // Color selector functionality
        $('.color-option').click(function() {
            const selectedColor = $(this).data('color');
            document.documentElement.style.setProperty('--photo-grid-bg', selectedColor);
            
            // Save preference to localStorage
            localStorage.setItem('photoGridBgColor', selectedColor);
            
            // Update active state
            $('.color-option').removeClass('active');
            $(this).addClass('active');
        });
        
        // Load saved color preference if it exists
        const savedColor = localStorage.getItem('photoGridBgColor');
        if (savedColor) {
            document.documentElement.style.setProperty('--photo-grid-bg', savedColor);
            $(`.color-option[data-color="${savedColor}"]`).addClass('active');
        } else {
            // Default to white
            $('.color-option[data-color="#ffffff"]').addClass('active');
        }
    });
</script>

<style>
    /* Color selector styles */
    .color-selector {
        display: flex;
        align-items: center;
    }
    
    .color-options {
        display: flex;
        gap: 5px;
    }
    
    .color-option {
        width: 40px;
        height: 40px;
        border-radius: 4px;
        border: 1px solid #ccc;
        cursor: pointer;
        transition: all 0.2s ease;
        padding: 0;
        background: none;
    }
    
    .color-option:hover {
        transform: scale(1.1);
    }
    
    .color-option.active {
        border: 2px solid var(--accent-color);
        transform: scale(1.1);
    }
</style>
{% endblock %}
